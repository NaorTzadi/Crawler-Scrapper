package org.example;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.WebDriverWait;
import java.net.HttpURLConnection;
import java.net.URL;
import java.time.Duration;
import java.util.*;
import java.util.stream.Collectors;

public class FileLinksExtractor {
    // צריך למצוא עוד דרכים לצמצום כמות הלינקים החשודים
    // צריך לנסות להפחית מהמשקל של הפונקציה isDownloadLink
    // יכול להיות שצריך להשתמש בסלניום ב-isDownloadLink כדי להוריד מהחשד של אתרים
    // בסיום לזכור להעביר ל- private מה שצריך
    static String[] downloadExtensions = new String[]{".pdf", ".doc", ".docx", ".xls", ".xlsx", ".zip", ".rar",".pptx",".mp3",".mp4"};
    public static boolean isDownloadLink(String link, WebDriver driver) {
        try {
            driver.get(link);
            // Wait for the page to load
            new WebDriverWait(driver, Duration.ofSeconds(10)).until(
                    webDriver -> ((JavascriptExecutor) webDriver).executeScript("return document.readyState").equals("complete")
            );
            // Check for signs of a CAPTCHA or robot check
            boolean isCaptchaPage = driver.findElements(By.xpath("//*[contains(text(),'CAPTCHA')]")).size() > 0 ||
                    driver.findElements(By.xpath("//*[contains(text(),'robot')]")).size() > 0;

            if (isCaptchaPage) {
                return true; // Assume it's a download link if CAPTCHA is detected
            } else {
                // Check for download indicators in headers using a head request as before
                URL url = new URL(link);
                HttpURLConnection connection = (HttpURLConnection) url.openConnection();
                connection.setRequestMethod("HEAD");
                connection.connect();

                int responseCode = connection.getResponseCode();
                if (responseCode == HttpURLConnection.HTTP_OK) {
                    String contentDisposition = connection.getHeaderField("Content-Disposition");
                    String contentType = connection.getHeaderField("Content-Type");

                    if ((contentDisposition != null && contentDisposition.contains("attachment")) ||
                            (contentType != null && !contentType.contains("text/html"))) {
                        return true;
                    }
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }
    public static Set<String> getAllDownloadLinks(String url){
        ChromeDriver chromeDriver = Utility.getModifiedChromeDriver();
        chromeDriver.get(url);
        Set<String> downloadLinks=new HashSet<>();
        Set<String> allLinks=extractHyperLinks(chromeDriver);
        Set<String> suspectedLinks=new HashSet<>();

        for (String link:allLinks){
            if (isDownloadLink(link)){
                downloadLinks.add(link);
            }
            String lowerCaseLink=link.toLowerCase();
            for (String extension:downloadExtensions){
                if (lowerCaseLink.endsWith(extension)){
                    downloadLinks.add(link);
                    break;
                }
                if (isSuspectedDownloadLink(link,extension)){
                    suspectedLinks.add(link);
                    break;
                }
            }
        }
        suspectedLinks.removeAll(downloadLinks);
        downloadLinks = downloadLinks.stream().filter(link -> link.length() <= 200 && !link.contains("#")).collect(Collectors.toSet());
        for(String link: suspectedLinks){
            if (isDownloadLink(link,chromeDriver)){ // כאן יכול להיות הרבה בקשות בזמן קצר ובכך להעלות את החשד
                downloadLinks.add(link);
            }
        }
        chromeDriver.close();// להיזהר! אם יש שימוש או יכול להיות שימוש מאוחר מכן באותו driver אז צריך למחוק
        return downloadLinks;
    }
    public static boolean isSuspectedDownloadLink(String link, String extension) {
        link = link.toLowerCase();
        return link.contains(extension.substring(1)) &&
                link.length() <= 200 &&
                !link.endsWith(".html") &&
                !link.endsWith(".php") &&
                !link.endsWith(".asp") &&
                !link.contains("#");
    }
    public static boolean isDownloadLink(String link) {
        return link.matches(".*\\.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar|7z|mp3|mp4)$") ||
                link.contains("file=") || link.contains("/file/") ||
                link.contains("dl_id=") || link.contains("blobtype=pdf") ||
                link.contains("filename=") || link.contains("file_id=") ||
                link.contains("id=") || link.contains("doc_id=") ||
                link.contains("action=download") || link.contains("getfile=")
                || link.contains("downloadfile=") || link.contains("token=");
    }
    public static Set<String> extractHyperLinks(WebDriver driver) {
        Set<String> allLinks = new HashSet<>();
        extractAllHyperLinks(driver, allLinks);
        List<WebElement> iframes = driver.findElements(By.tagName("iframe"));
        for (WebElement iframe : iframes) {
            driver.switchTo().frame(iframe);
            extractAllHyperLinks(driver, allLinks);
            driver.switchTo().defaultContent();
        }
        return allLinks;
    }
    private static void extractAllHyperLinks(WebDriver driver, Set<String> allLinks) {
        List<WebElement> links = driver.findElements(By.tagName("a"));
        for (int i = 0; i < links.size(); i++) {
            try {
                WebElement link = links.get(i);
                String href = link.getAttribute("href");
                if (href != null) {
                    allLinks.add(href);
                }
            } catch (StaleElementReferenceException e) {
                links = driver.findElements(By.tagName("a"));
                i--;
            }
        }
        List<WebElement> buttons = driver.findElements(By.cssSelector("[data-jam-url]"));
        for (WebElement button : buttons) {
            String dataUrl = button.getAttribute("data-jam-url");
            if (dataUrl != null && !allLinks.contains(dataUrl)) {
                allLinks.add(dataUrl);
            }
        }
    }

 /*   public static void extractEmbeddedPdfLinks(WebDriver driver, List<String> pdfLinks) {
        List<WebElement> pdfViewerElements = driver.findElements(By.xpath("//embed[@type='application/pdf']"));
        pdfViewerElements.addAll(driver.findElements(By.xpath("//iframe[contains(@src, 'pdf')]")));
        for (WebElement element : pdfViewerElements) {
            String src = element.getAttribute("src");
            System.out.println("embedded link: "+src);
            if (src != null && !pdfLinks.contains(src)) {
                pdfLinks.add(src);
            }
        }
    }
    private static void extractEmbeddedFileLinks1(WebDriver driver, List<String> fileLinks, String extension) { // extensions לפי embedded files
        List<WebElement> fileViewerElements = driver.findElements(By.xpath("//embed[contains(@src, '" + extension + "')]"));
        for (WebElement element : fileViewerElements) {
            String src = element.getAttribute("src");
            System.out.println("embedded link: "+src);
            if (src != null && !fileLinks.contains(src)) {
                fileLinks.add(src);
            }
        }
    }
    private static void extractEmbeddedFileLinks2(WebDriver driver, List<String> fileLinks) { // כל embedded files
        List<WebElement> embedElements = driver.findElements(By.tagName("embed"));
        for (WebElement element : embedElements) {
            String src = element.getAttribute("src");
            System.out.println("embedded link: "+src);
            if (src != null && !fileLinks.contains(src)) {
                fileLinks.add(src);
            }
        }
    }*/




}
